============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.4.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
rootdir: /home/users/duynguy/proj/sql_exev
configfile: pyproject.toml
plugins: anyio-4.11.0
collecting ... collected 6 items

tests/test_golden_set.py::test_golden_set[01_composite_index] FAILED

=================================== FAILURES ===================================
_____________________ test_golden_set[01_composite_index] ______________________

test_name = '01_composite_index'

    @requires_db
    @requires_llm
    @pytest.mark.golden
    @pytest.mark.parametrize("test_name", list(VILLAIN_QUERIES.keys()))
    def test_golden_set(test_name: str):
        spec = VILLAIN_QUERIES[test_name]
        result = run_exev_gauntlet(spec["sql"])
    
        fb = result.get("feedback", {})
        status = (fb.get("status") or "").lower()
        suggestion = fb.get("suggestion", "") or ""
    
        # 1) Status check
        assert status == spec["expected_status"], (
            f"[{test_name}] Expected status '{spec['expected_status']}', got '{status}'\n"
            f"Reason: {fb.get('reason')}\nSuggestion: {suggestion}"
        )
    
        # 2) Suggestion contains expected fragments
        for frag in spec.get("expected_suggestion_includes", []):
            assert frag in suggestion, (
                f"[{test_name}] Suggestion did not include '{frag}'.\n"
                f"Suggestion: {suggestion}"
            )
    
        # 3) Optional improvement threshold using HypoPG proof
        if "expected_improvement_min" in spec:
            proof = result.get("hypopg_proof")
            assert proof, f"[{test_name}] hypopg_proof block missing"
            improvement = proof.get("improvement")
            assert improvement is not None, f"[{test_name}] improvement not found in hypopg_proof"
>           assert improvement <= spec["expected_improvement_min"], (
                f"[{test_name}] Expected improvement <= {spec['expected_improvement_min']}%, got {improvement}%"
            )
E           AssertionError: [01_composite_index] Expected improvement <= -50.0%, got 0.0%
E           assert 0.0 <= -50.0

tests/test_golden_set.py:134: AssertionError
=========================== short test summary info ============================
FAILED tests/test_golden_set.py::test_golden_set[01_composite_index] - Assert...
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
============================== 1 failed in 14.29s ==============================
